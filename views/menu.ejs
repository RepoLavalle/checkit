<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
    <h1>Sistema Checklist</h1>
    <h2>Menú:</h2>
    <hr>   
    <pre id='intercambio'><%= contenido %></pre>
    <pre><%= valUsu.carga.nombre %></pre>
    <pre><%= valUsu.carga.apellido %></pre>
    <pre><%= valUsu.carga.nomUsu %></pre>
    <button onclick="volver()">Salir</button>
    <div id="cu10">
        <hr>

        <button id="colapsarNuevoControl" onclick="colapsarNuevoControl()">Nuevo Control</button>
        <div id="nuevoControl">
            <p>
            <label for="parametro">Parámetro:&nbsp;</label>
            <input type="text" name="parametro" id="parametro">
            </p>
            <p>
            <label for="periodicidad">Periodicidad:&nbsp;</label>
            <input type="number" name="periodicidad" id="periodicidad">
            </p>
            <p>
            <label>Prorrogable:</label>
            <input type="radio" id="radio11" name="prorrogable" value="si">
            <label for="radio1">Sí</label>
            <input type="radio" id="radio12" name="prorrogable" value="no">
            <label for="radio2">No</label>
            </p>
            <p>
            <label>Reajustable:</label>
            <input type="radio" id="radio21" name="reajustable" value="si">
            <label for="radio1">Sí</label>
            <input type="radio" id="radio22" name="reajustable" value="no">
            <label for="radio2">No</label>
            </p>
            <p><label>A partir de:&nbsp;</label><input type="date"  id="desde" name="desde"></p>

            <button onclick="cu10_nuevoControl()">Agregar</button>
        </div>
        <script>
            const divParCer = []; //Global cerrar todos los divs
            const miDiv = document.getElementById('nuevoControl');

            divParCer.push(miDiv);
            miDiv.style.display = 'none';

            function colapsarNuevoControl(){
                
                if (miDiv.style.display === 'none') {
                    cerrarDivs();
                    miDiv.style.display = 'block'; // Cambia a 'block' para mostrar el contenido
                } else {
                    miDiv.style.display = 'none'; // Cambia a 'none' para ocultar el contenido
                }
                
            }
        </script>

        <hr>

        <button onclick="activarListarControles()">Mis controles</button>
        <div id="cu11_listarControles"></div>
        <script>
            
            const divLisCon = document.getElementById('cu11_listarControles');
            divLisCon.style.display = 'none';

            divParCer.push(divLisCon);

            function activarListarControles(){
                
                if(divLisCon.style.display === 'none'){
                    cerrarDivs();
                    divLisCon.style.display = 'block'; // Cambia a 'block' para mostrar el contenido
                    cu11_listarControles()
                } else {
                    divLisCon.style.display = 'none'; // Cambia a 'none' para ocultar el contenido    
                }
            }
        </script>

        <!-- button onclick='cu12_actualizarControles()'>Actualizar</button -->

        <hr>
        <button onclick="activarListarVerificadores()">Mis Verificadores</button>
        <div id="cu13_listarVerificadores"></div>

        <script>
            const divLisVer = document.getElementById('cu13_listarVerificadores');
            divLisVer.style.display = 'none';

            divParCer.push(divLisVer);

            function activarListarVerificadores(){
                
                if(divLisVer.style.display === 'none'){
                    cerrarDivs();
                    divLisVer.style.display = 'block';
                    cu13_listarVerificadores();
                }else{
                    divLisVer.style.display = 'none'
                }
            }
        </script>

        <hr><!-- cu14 -->
        <button onclick='activarNuevaLista()'>Nueva Lista</button>
        <div id="divNuevaLista">
            <p><label>Nombre de Mi Nueva Lista: &nbsp;</label><input type="text" id="cu14_input"></p>
            <button onclick="cu14_nuevaLista()">Crear</button>
        </div>
        <script>
            const divNueLis = document.getElementById('divNuevaLista');
            divNueLis.style.display = 'none';
            
            divParCer.push(divNueLis);

            function activarNuevaLista(){
                
                if(divNueLis.style.display === 'none'){
                    cerrarDivs();
                    divNueLis.style.display = 'block';
                    cu13_listarVerificadores();
                    divLisVer.style.display = 'block';
                    cu11_listarControles();               
                    divLisCon.style.display = 'block';

                }else{
                    divNueLis.style.display = 'none';
                    divLisVer.style.display = 'none';
                    divLisCon.style.display = 'none';                    
                }
            }
        </script>

        <hr><!-- cu16 -->

        <p><button onclick="activarMostrarListas()">Mis Listas:</button></button></p>
        <div id="cu15_listarListas"></div>

        <script>
            const divMosMis = document.getElementById('cu15_listarListas');
            divMosMis.style.display = 'none';

            divParCer.push(divMosMis);
            
            function activarMostrarListas(){
                
                if(divMosMis.style.display === 'none'){
                    cerrarDivs();
                    divMosMis.style.display = 'block';
                    cu15_listarListas()
                }else{
                    divMosMis.style.display = 'none';
                }
            }

        </script>

        <dialog>
            <p>Este es el contenido de la ventana modal.</p>
            <div id="modal"></div>
            <button onclick="document.querySelector('dialog').close()">Close</button>
        </dialog>
          
        <!--button onclick="document.querySelector('dialog').showModal()">Open</button-->

        <hr>
        <button onclick='activarVerificar()'>Listas para Verificar</button>
        <div id="cu17_listasVerificar">xxx</div>

        <script>
            const divVerVer = document.getElementById('cu17_listasVerificar');
            divVerVer.style.display == 'none';

            divParCer.push(divVerVer);

            function activarVerificar(){
                
                if(divVerVer.style.display === 'none'){
                    cerrarDivs();
                    divVerVer.style.display = 'block';
                    cu17_listasVerificar();
                }else{
                    divVerVer.style.display = 'none';
                }
            }
        </script>

        <!-- Cierra todos div's que no se ocupan -->
        <script>
            function cerrarDivs(){
                for(var i=0 ; i<divParCer.length ; i++){
                    divParCer[i].style.display = 'none'
                }
            }
        </script>
          
    </div>
    <script>

        var str_data = document.getElementById('intercambio').innerText;
        console.log(str_data);
        let user = JSON.parse(str_data)
        console.log(user);


        function cu10_nuevoControl(){
            let cu10Nombre = document.getElementById('parametro').value;
            document.getElementById('parametro').value = "";
            //console.log(cu10Nombre);

            let per = document.getElementById('periodicidad').value;
            document.getElementById('periodicidad').value = "";
            //console.log(per)

            pro = document.getElementsByName('prorrogable');
            let prorrogable = false;
            pro[0].checked?prorrogable=true:prorrogable=false;
            document.getElementsByName('prorrogable').checked = false
            //console.log(prorrogable);

            rea = document.getElementsByName('reajustable');
            let reajustable = false;
            rea[0].checked? reajustable=true:null;
            console.log(reajustable);

            document.getElementById('radio11').checked = false
            document.getElementById('radio12').checked = false
            document.getElementById('radio21').checked = false
            document.getElementById('radio22').checked = false

            des = document.getElementById('desde').value;
            document.getElementById('desde').value = ""
            // console.log(des)
            // console.log(JSON.stringify(des))

            let layer0 = {}
            layer0.parametro = cu10Nombre
            layer0.periodicidad = per
            layer0.prorrogable = prorrogable
            layer0.reajustable = reajustable
            layer0.desde = des

            let layer1 = {}
            layer1.cu = "nuevoControl"
            layer1.carga = layer0
            layer1.usuario = user

            fetch('http://localhost:3000/api',{
                method: 'POST',
                body: JSON.stringify(layer1),
                headers: {'Content-Type' : 'application/json'}
            }).then(cu11_listarControles())  // 20231205

        }

        function cu11_listarControles(){
           
            // let listaControles = document.getElementById('cu11_listarControles').innerHTML == '';
            // console.log(listaControles);
            // if(listaControles){
                
                let layer0 = {}

                let layer1 = {}
                layer1.cu = "cu11_listarControles"
                layer1.carga = layer0
                layer1.usuario = user

                fetch('http://localhost:3000/api',{
                    method: 'POST',
                    body: JSON.stringify(layer1),
                    headers: {'Content-Type' : 'application/json'}
                })
                .then(data=>data.json())
                .then(data=>listarControles(data[0]))
            // }else{
            //     console.log("running else....")
            //     document.getElementById('cu11_listarControles').value == "";
            // }

        }

        // cu12 ---------------------------

        function cu12_actualizarControles(){
            //alert('implementar...')
            let layer0 = matObj;

            let layer1 = {}
            layer1.cu = "cu12_actualizarControles"
            layer1.carga = layer0
            layer1.usuario = user

            fetch('http://localhost:3000/api',{
                method: 'POST',
                body: JSON.stringify(layer1),
                headers: {'Content-Type' : 'application/json'}
            })

            
        }

        let matObj = []; // Global

        function listarControles(data){
            //console.log(data);
            matObj = data.controles;            
            armarDisplay(data.controles)

        }

        let marCon = [];

        function armarDisplay(matObj){
            var display = document.getElementById('cu11_listarControles');
            // construyo los botones a partir del vector
            var btn = ""
            var str1 =""
            for(var i=0 ; i<matObj.length ; i++){
                var strObj = JSON.stringify(matObj[i]);
                marCon[i]==true?str1="X":str1="&nbsp;"
                btn += "<button id='"+strObj+"' onclick='seleccionar(this)'>"+str1+"</button>&nbsp;"+ 
                    "<label>"+matObj[i].parametro+
                    "<button id='"+strObj+"' onclick='periodicidad(this)'>"+matObj[i].periodicidad+"</button>"+                 
                    "<button id='"+strObj+"' onclick='prorrogable(this)'>"+    matObj[i].prorrogable+"</button>"+
                    "<button id='"+strObj+"' onclick='reajustable(this)'>"+    matObj[i].reajustable+"</button>"+
                    "<button id='"+strObj+"' onclick='eliminar(this)'>"+    "Eliminar"+"</button>"+
                    "<br>"
                    

            }
            btn += "<button onclick='cu12_actualizarControles()'>Actualizar</button>";
            display.innerHTML = btn
        }

        function seleccionar(data){
            //console.log(JSON.parse(data.getAttribute('id')));
            let objSel = JSON.parse(data.getAttribute('id'));
            for(var i=0 ; i<matObj.length ; i++){
                if(matObj[i].parametro == objSel.parametro){
                    marCon[i] == true?marCon[i]=null:marCon[i]=true;
                }
            }
            console.log(marCon);
            armarDisplay(matObj)
        }

        function periodicidad(data){
            
            var newObj = JSON.parse(data.getAttribute('id'))

            let nuevaPeriodicidad    = prompt('Ingrese nuevo valor en días:')
            console.log(nuevaPeriodicidad);
            if(nuevaPeriodicidad){
                newObj.periodicidad =nuevaPeriodicidad 
            }
                             

            remMos(newObj)
        }        

        function prorrogable(data){
            
            var newObj = JSON.parse(data.getAttribute('id'))

            newObj.prorrogable?newObj.prorrogable = false : newObj.prorrogable = true ;

            remMos(newObj)
            
        }

        function reajustable(data){
            var newObj = JSON.parse(data.getAttribute('id'))

            newObj.reajustable?newObj.reajustable = false : newObj.reajustable = true ;

            remMos(newObj)            
        }

        function eliminar(data){
            var newObj = JSON.parse(data.getAttribute('id'))

            var newMatObj = matObj.filter(x=>x.parametro != newObj.parametro)

            matObj = newMatObj
            armarDisplay(matObj)
        }

        function remMos(newObj){
            for(var i=0 ; i<matObj.length ; i++){
                if(matObj[i].parametro == newObj.parametro){
                    matObj[i] = newObj
                }
            }
            armarDisplay(matObj)            
        }

        // cu13 ---------------------------


        function cu13_listarVerificadores(){

            let layer0 = {}

            let layer1 = {}
            layer1.cu = "cu13_listarVerificadores"
            layer1.carga = layer0
            layer1.usuario = user

            fetch('http://localhost:3000/api',{
                method: 'POST',
                body: JSON.stringify(layer1),
                headers: {'Content-Type' : 'application/json'}
            })
            .then(data=>data.json())
            //.then(data=>console.log(data))
            .then(data=>listarVerificadores(data))
        }

        let matVer = []  // Global
        let matMar = []  // Verificadores seleccionados.
        
        function listarVerificadores(data){
            let disVer = document.getElementById('cu13_listarVerificadores')
            disVer.innerHTML = "hola"
            matVer = data;
 
            let str  = "";
            let str2 = "";
            let str3 = "";
            
            for(var i=0 ; i<data.length ; i++){
                matMar[i]== null ? str3 = "&nbsp;" : str3 = "X";
                str2 = JSON.stringify(data[i])
                str += "<p><button onclick='selVer(this)' "+
                    "id='"+str2+"'"+
                    ">"+str3+"</button>&nbsp;" + data[i].nombre + "</p>"
            }

            disVer.innerHTML = str;
        }

        function selVer(data){

            // Obtengo el objeto
            let eveObj = JSON.parse(data.getAttribute('id'));

            // Recorro el vector de objetos para ver cuál es el seleccionado
            let i=-1
            do{
                i += 1;    
            } while(matVer[i].nomUsu != eveObj.nomUsu);

            //console.log(i)

            // cambio el estado de marca
            matMar[i]==null?matMar[i]=true:matMar[i]=null;
            
            console.log(matMar);
            listarVerificadores(matVer)

        }
        
        // cu14 Nueva Lista

        function cu14_nuevaLista(){
            console.log("cu14 Nueva Lista")
            console.log(matVer)
            console.log(matMar)
            console.log(matObj)
            console.log(marCon)


           // Colectar los usuarios seleccionados            
            let lisVer = []//Objeto Lista - atributo Verificadores
            for(var i=0 ; i<matMar.length ; i++){
                matMar[i]?lisVer.push(matVer[i]):null;
            }
            console.log("lisVer")
            console.log(lisVer)

            // Colectar los controles seleccionados
            let lisCon = []
            for(var i=0 ; i<matObj.length ; i++){
                marCon[i]?lisCon.push(matObj[i]):null;
            }
            console.log("lisCon")
            console.log(lisCon)

            // crear un objeto js con los datos recopilados del formulario
            let lis = {}
            lis.autor = user
            lis.nombre = document.getElementById('cu14_input').value;
            lis.controles =     lisCon;
            lis.observadores =  [];
            lis.verificadores=  lisVer;
            console.log(lis)

            // Creo el paquete
            let layer0 = lis

            let layer1 = {}
            layer1.cu = "cu14_nuevaLista"
            layer1.carga = layer0
            layer1.usuario = user

            fetch('http://localhost:3000/api',{
                method: 'POST',
                body: JSON.stringify(layer1),
                headers: {'Content-Type' : 'application/json'}
            })

        }

        // cu15 Listar Listas
        
        let estLisDes = false // Gloabal: El estado de las listas desplegadas

        function cu15_listarListas(){
            // estLisDes = document.getElementById('cu15_listarListas').innerHTML == '';
            // if(estLisDes){
                let layer0 = {}

                let layer1 = {}
                layer1.cu = "cu15_listarListas"
                layer1.carga = layer0
                layer1.usuario = user

                fetch('http://localhost:3000/api',{
                    method: 'POST',
                    body: JSON.stringify(layer1),
                    headers: {'Content-Type' : 'application/json'}
                })
                .then(data=>data.json())
                //.then(data=>console.log(data))
                .then(data=>listarListas(data))
            // }else{
            //     document.getElementById('cu15_listarListas').innerHTML = '';
            // }
        }

        let lisLis = []  // Global
        let lisMar = []  // Verificadores seleccionados.            
        

        function listarListas(data){
            //cu15
            console.log("Listas de Control: --------------------")
            let str = "";
            for(var i=0 ; i<data.length ; i++){
                let str2 = JSON.stringify(data[i]);
                console.log("\n"+data[i].nombre)
                str += "<p><button id='"+str2+"' onclick='modificarLista(this)'>&nbsp;&nbsp;</button>&nbsp;<b>"+data[i].nombre+"</b></p>"

                console.log("Verificadores:")
                str += "<p><u>Verificadores:</u></p>"
                str += "<ul>"
                for(var j=0 ; j<data[i].verificadores.length ; j++){
                    console.log("  "+data[i].verificadores[j].nombre)
                    str += "<li>  "+data[i].verificadores[j].nombre+"</li>"
                }
                str += "</ul>"


                console.log("Controles:")
                str += "<p><u>Controles:</u></p>";

                var hoy = new Date()
                var otro;
                

                str += "<ul>"
                for(var j=0 ; j<data[i].controles.length ; j++){

                    otro = new Date(data[i].controles[j].ultimaVer)
                    var difDias = parseInt( (hoy.getTime()-otro.getTime() )/(1000*60*60*24))
                    difDias>data[i].controles[j].periodicidad?str3='red':str3='blue';
                    
                    console.log("  "+data[i].controles[j].parametro+"  difDias: "+difDias)
                    str += "<li style='color: "+str3+";'>  "+data[i].controles[j].parametro+
                    " - Verificación: "+difDias+"</li>"
                }
                str += "</ul>"
            }
            document.getElementById('cu15_listarListas').innerHTML = str;
        }
        
        // cu16 
        function modificarLista(arg1){
            var lis = JSON.parse(arg1.getAttribute('id'))
            console.log(lis);
            let modal = document.getElementById('modal');

            var str = "---- "+lis.nombre+" ----\n"
            str +="\n";
            for(var i=0 ; i<matVer.length ; i++){
                str += "   "+matVer[i].nombre+"\n"
            }
            str +="\n";
            for(var i=0 ; i<matObj.length ; i++){
                str += matObj[i].parametro+"\n"
            }

            modal.innerText = str;
            document.querySelector('dialog').showModal()
        }
    
        function cu17_listasVerificar(){
            // if(document.getElementById('cu17_listasVerificar').innerHTML == ""){
                console.log("cu17");
                // <div id="cu17_listasVerificar"></div>xxx
                let layer0 = {}

                let layer1 = {}
                layer1.cu = "cu17_listasVerificar"
                layer1.carga = layer0
                layer1.usuario = user

                fetch('http://localhost:3000/api',{
                    method: 'POST',
                    body: JSON.stringify(layer1),
                    headers: {'Content-Type' : 'application/json'}
                })
                .then(data=>data.json())
                .then(data=>mostrarVerificar(data))
                //.then(data=>listarListas(data))

            // }else{
            //     document.getElementById('cu17_listasVerificar').innerHTML = "";
            // }
        }

        function mostrarVerificar(data){
            console.log(data);

            let str ="";
            let strId = "";
            for(var i=0 ; i<data.length ; i++){
                const obj  = {}
                console.log(data[i]);
                //console.log("Nombre de la Lista: "+data[i].nombre)
                str += "<hr><p>Nombre de la Lista: <b>"+data[i].nombre+ "</b></p>";
                obj.nombre = data[i].nombre;

                //console.log("Lista solicitada por: "+data[i].autor.nombre);
                str += "<p><b>Lista solicitada por: </b>"+data[i].autor.nombre + "</p>";
                obj.autor = data[i].autor.nomUsu

                console.log("Verificadores: ")
                
                let str2 = ""
                for(var j=0 ; j<data[i].verificadores.length ; j++ ){
                    //console.log(data[i].verificadores[j].nombre)
                    str2 += " "+data[i].verificadores[j].nombre
                }
                str += "</p><b>Verificadores:</b>"+str2+" </p>"

                //console.log("Lista de parámetros: ")
                str +="<p>Lista de parámetros:&nbsp;</p>"
                str2 = "";
                for(var j=0 ; j<data[i].controles.length ; j++){
                    console.log(data[i].controles[j].parametro)
                    obj.parametro = data[i].controles[j].parametro;
                    let strId = JSON.stringify(obj);
                    //str2 +="<li><input type='checkbox'>"+data[i].controles[j].parametro+"</li>"
                    str +="<p><button id='"+strId+"' onclick='cu18_procesar(this)' style='background-color: green; color: white;'>&nbsp;</button>&nbsp;"+data[i].controles[j].parametro+"</p>"

                }
            }
    
            document.getElementById('cu17_listasVerificar').innerHTML = str;

        }
    
        function cu18_procesar(arg){
            console.log(arg);
            const boton = arg;
            const estiloBoton = window.getComputedStyle(boton);

            // Obtener el color de fondo
            const colorFondo = estiloBoton.backgroundColor;
            console.log(`Color de fondo: ${colorFondo}`);

            // Obtener el color del texto
            const colorTexto = estiloBoton.color;
            console.log(`Color del texto: ${colorTexto}`);
            
        }
    </script>
    
    

    <script>
        function volver(){
            location.href = "http://localhost:3000";
        }
    </script>
</body>
</html>